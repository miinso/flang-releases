---
name: LLVM Version Watch

on:
  schedule:
    - cron: '15 2 * * *'
  workflow_dispatch:

jobs:
  check-and-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check latest LLVM patch
        id: check
        shell: bash
        run: |
          set -euo pipefail
          python3 scripts/check_llvm_updates.py \
            --versions-file versions.env \
            --fork-ref-template "flang-wasm32-llvmorg-{version}" \
            --github-output "$GITHUB_OUTPUT"

      - name: Update versions.env
        if: steps.check.outputs.needs_update == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python3 scripts/check_llvm_updates.py \
            --versions-file versions.env \
            --fork-ref-template "flang-wasm32-llvmorg-{version}" \
            --write

      - name: Create pull request
        if: steps.check.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: bump LLVM to ${{ steps.check.outputs.latest_version }}"
          branch: "automation/llvm-${{ steps.check.outputs.latest_version }}"
          title: "chore: bump LLVM to ${{ steps.check.outputs.latest_version }}"
          body: |
            Automated LLVM update.

            - Tracked minor: `${{ steps.check.outputs.tracked_minor }}`
            - Current: `${{ steps.check.outputs.current_version }}`
            - Latest: `${{ steps.check.outputs.latest_version }}`
            - Next fork ref: `${{ steps.check.outputs.next_fork_ref }}`

            After merging, run `ci-full.yml` and validate the new fork ref build before creating a release.
          labels: |
            dependencies
            automation

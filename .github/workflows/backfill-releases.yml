---
name: Backfill Releases

on:
  workflow_dispatch:
    inputs:
      versions:
        description: 'JSON array of versions, e.g. ["20.1.0","20.1.1"]'
        required: true
        type: string
      draft:
        description: 'Create releases as drafts'
        required: true
        default: true
        type: boolean
      dry_run:
        description: 'Only print what would be dispatched'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: write

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate and dispatch releases
        env:
          GH_TOKEN: ${{ github.token }}
          VERSIONS: ${{ inputs.versions }}
          DRAFT: ${{ inputs.draft }}
          DRY_RUN: ${{ inputs.dry_run }}
        shell: bash
        run: |
          set -euo pipefail

          # parse version list
          mapfile -t versions < <(echo "$VERSIONS" | python3 -c "
          import sys, json
          for v in json.load(sys.stdin):
              print(v)
          ")

          if [ ${#versions[@]} -eq 0 ]; then
            echo "::error::No versions provided"
            exit 1
          fi

          echo "Will process ${#versions[@]} versions: ${versions[*]}"

          # check existing releases
          existing_tags="$(gh release list --limit 200 --json tagName -q '.[].tagName' 2>/dev/null || true)"

          for version in "${versions[@]}"; do
            tag="v${version}"
            if echo "$existing_tags" | grep -qx "$tag"; then
              echo "::warning::Release $tag already exists, skipping"
              continue
            fi

            # derive patches dir from major
            llvm_major="${version%%.*}"
            patches_dir="patches/${llvm_major}"
            if [ ! -d "$patches_dir" ]; then
              echo "::error::No patches directory for major ${llvm_major}: $patches_dir"
              exit 1
            fi

            # derive fork ref: try flang-wasm32 fork first, fall back to upstream tag
            fork_ref="llvmorg-${version}"

            echo "--- ${version} ---"
            echo "  tag:        $tag"
            echo "  fork_ref:   $fork_ref"
            echo "  patches:    $patches_dir"
            echo "  draft:      $DRAFT"

            if [ "$DRY_RUN" = "true" ]; then
              echo "  [dry run] skipping dispatch"
              continue
            fi

            gh workflow run release.yml \
              -f rebuild=true \
              -f "version=${version}" \
              -f "tag=${tag}" \
              -f "llvm_fork_ref=${fork_ref}" \
              -f "draft=${DRAFT}"

            echo "  dispatched release.yml for ${version}"

            # throttle to avoid overwhelming runners
            sleep 10
          done

          echo "done. dispatched releases for ${#versions[@]} versions."
